{% extends 'base.html' %}

{% block title %}Focus Timer - EduFlow AI{% endblock %}

{% block content %}
<h1><i class="bi bi-stopwatch"></i> Focus Timer</h1>

<!-- Overload Alert -->
{% if overload_status.alert %}
<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> {{ overload_status.message }}
    <div class="progress mt-2">
        <div class="progress-bar bg-warning" style="width: {{ overload_status.percentage }}%">
            {{ overload_status.percentage }}%
        </div>
    </div>
</div>
{% endif %}

<!-- Active Session -->
{% if active_session %}
<div class="card border-success mb-4">
    <div class="card-body text-center">
        <h3 class="text-success"><i class="bi bi-play-circle-fill"></i> Active Focus Session</h3>
        {% if active_session.study_session %}
        <p class="lead"><strong>Event:</strong> {{ active_session.study_session.event.title }}</p>
        <p class="text-muted">Study Session: {{ active_session.study_session.duration_minutes }} minutes target</p>
        {% endif %}
        <p class="lead">Model: {{ active_session.focus_model.name|default:"Custom" }}</p>

        <!-- Countdown Timer -->
        <div class="timer-display my-4">
            <h1 class="display-1 fw-bold" id="countdown-timer">--:--</h1>
            <p class="text-muted">Time Remaining</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress mb-3" style="height: 30px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 id="timer-progress"
                 style="width: 0%"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100">
                <span id="progress-text">0%</span>
            </div>
        </div>

        <p class="small text-muted">Started: {{ active_session.start_time|time:"g:i A" }}</p>

        <a href="{% url 'end_focus_session' active_session.pk %}" class="btn btn-danger btn-lg">
            <i class="bi bi-stop-circle"></i> End Session
        </a>
    </div>
</div>

<script>
// Countdown Timer Script
(function() {
    const startTime = new Date("{{ active_session.start_time.isoformat }}");
    const focusDuration = {{ active_session.focus_model.focus_duration }} * 60; // in seconds

    function updateTimer() {
        const now = new Date();
        const elapsedSeconds = Math.floor((now - startTime) / 1000);
        const remainingSeconds = Math.max(0, focusDuration - elapsedSeconds);

        // Calculate minutes and seconds
        const minutes = Math.floor(remainingSeconds / 60);
        const seconds = remainingSeconds % 60;

        // Update display
        document.getElementById('countdown-timer').textContent =
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

        // Update progress bar
        const progress = Math.min(100, (elapsedSeconds / focusDuration) * 100);
        const progressBar = document.getElementById('timer-progress');
        const progressText = document.getElementById('progress-text');

        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = Math.floor(progress) + '%';

        // Change color when time is up
        if (remainingSeconds === 0) {
            progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
            document.getElementById('countdown-timer').classList.add('text-success');

            // Optional: Play sound or notification
            if (Notification.permission === 'granted') {
                new Notification('Focus Session Complete!', {
                    body: 'Great work! Time for a break.',
                    icon: '/static/icon.png'
                });
            }
        }

        // Continue updating every second
        if (remainingSeconds >= 0) {
            setTimeout(updateTimer, 1000);
        }
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Start the timer
    updateTimer();
})();
</script>
{% else %}
<!-- Focus Model Selection -->
<div class="row mb-4">
    <div class="col-md-12">
        <h4>Choose a Focus Model</h4>
    </div>
    {% for model in focus_models %}
    <div class="col-md-4 mb-3">
        <div class="card focus-model-card {% if model == preference.default_focus_model %}active{% endif %}">
            <div class="card-body text-center">
                <h5>{{ model.name }}</h5>
                <p class="display-6">{{ model.focus_duration }}/{{ model.break_duration }}</p>
                <p class="text-muted">{{ model.description }}</p>
                <form method="post" action="{% url 'start_focus_session' %}">
                    {% csrf_token %}
                    <input type="hidden" name="focus_model" value="{{ model.id }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle"></i> Start
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Today's Stats -->
<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0">Today's Focus Time</h5>
    </div>
    <div class="card-body text-center">
        <h2 class="display-4 text-primary">{{ daily_minutes }} minutes</h2>
        <p class="lead">({{ daily_minutes }} min = approx. {{ daily_hours|floatformat:2 }} hours)</p>
    </div>
</div>
{% endblock %}
